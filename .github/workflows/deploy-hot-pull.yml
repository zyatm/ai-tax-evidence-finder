name: Hot Deploy (Pull-Based - No SSH)

# EC2 instance runs a GitHub Actions runner that pulls and deploys locally
# No SSH keys needed in GitHub secrets!

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # TEST JOB - Runs on GitHub hosted runner (no credentials needed)
  # ============================================================================
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint with flake8
        run: |
          pip install flake8
          flake8 src/ --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: Validate config files
        run: |
          python -c "import json; json.load(open('config/default_config.json'))"
          python -c "import json; json.load(open('config/custom_example.json'))"
          echo "✓ Config files are valid JSON"

      - name: Test config loading
        run: |
          python -c "
          import sys
          import os
          sys.path.insert(0, 'src')
          os.environ['ANTHROPIC_API_KEY'] = 'test-key'
          from stage2_verbatim import VerbatimExtractor
          e = VerbatimExtractor(config_path='config/default_config.json')
          assert len(e.blocks) == 6, 'Should load 6 blocks'
          print('✓ Config loading works')
          "

  # ============================================================================
  # DEPLOY JOB - Runs on self-hosted runner (your EC2)
  # ============================================================================
  hot-deploy:
    name: Hot Deploy via Self-Hosted Runner
    runs-on: [self-hosted, production]  # Runs on your EC2 instance
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create backup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          BACKUP_DIR="/app/backups"

          sudo mkdir -p "$BACKUP_DIR"

          if [ -d "/app/src" ]; then
            echo "==> Creating backup: hot-backup-$TIMESTAMP.tar.gz"
            sudo tar -czf "$BACKUP_DIR/hot-backup-$TIMESTAMP.tar.gz" \
              -C /app src config run.py 2>/dev/null || true
          fi

      - name: Hot deploy (atomic swap)
        run: |
          echo "==> Performing atomic file replacement..."

          # Create staging area
          sudo mkdir -p /app/.staging
          sudo cp -r ${{ github.workspace }}/src /app/.staging/
          sudo cp -r ${{ github.workspace }}/config /app/.staging/
          sudo cp ${{ github.workspace }}/run.py /app/.staging/
          sudo cp ${{ github.workspace }}/requirements.txt /app/.staging/

          # Atomic swaps (instant)
          sudo mv /app/src /app/src.old 2>/dev/null || true
          sudo mv /app/.staging/src /app/src

          sudo mv /app/config /app/config.old 2>/dev/null || true
          sudo mv /app/.staging/config /app/config

          sudo mv /app/run.py /app/run.py.old 2>/dev/null || true
          sudo mv /app/.staging/run.py /app/run.py

          sudo mv /app/requirements.txt /app/requirements.txt.old 2>/dev/null || true
          sudo mv /app/.staging/requirements.txt /app/requirements.txt

          # Clean up
          sudo rm -rf /app/src.old /app/config.old /app/run.py.old /app/requirements.txt.old /app/.staging

          echo "✓ Files deployed atomically"

      - name: Update Python dependencies
        run: |
          echo "==> Updating Python dependencies..."
          cd /app
          sudo pip3 install -r requirements.txt --quiet --upgrade 2>&1 | grep -v "already satisfied" || true
          echo "✓ Dependencies updated"

      - name: Set permissions
        run: |
          sudo chown -R 1000:1000 /app/src /app/config /app/run.py
          echo "✓ Permissions set"

      - name: Verify deployment
        run: |
          echo "==> Verifying deployment..."
          cd /app
          python3 -c "
          import sys
          sys.path.insert(0, 'src')
          from stage2_verbatim import VerbatimExtractor
          import os
          os.environ['ANTHROPIC_API_KEY'] = 'test-key'
          e = VerbatimExtractor(config_path='config/default_config.json')
          assert len(e.blocks) == 6
          print('✓ Extraction engine verified')
          "

      - name: Check n8n status
        run: |
          if sudo docker ps | grep -q n8n; then
            echo "✓ n8n is still running (no restart occurred)"
            UPTIME=$(sudo docker ps --filter "name=n8n" --format "{{.Status}}")
            echo "   n8n status: $UPTIME"
          else
            echo "⚠️ n8n container not found (this is OK if n8n isn't deployed yet)"
          fi
        continue-on-error: true

      - name: Deploy n8n workflows
        run: |
          echo "==> Deploying n8n workflows..."
          WORKFLOW_DIR="${{ github.workspace }}/n8n/workflows"

          if [ -d "$WORKFLOW_DIR" ] && [ "$(ls -A $WORKFLOW_DIR/*.json 2>/dev/null)" ]; then
            for workflow_file in $WORKFLOW_DIR/*.json; do
              workflow_name=$(basename "$workflow_file" .json)
              echo "  • Importing: $workflow_name"

              # Copy workflow to container and import
              sudo docker cp "$workflow_file" n8n:/tmp/workflow.json
              sudo docker exec n8n chmod 644 /tmp/workflow.json
              sudo docker exec -u root n8n n8n import:workflow --input=/tmp/workflow.json 2>&1 || true
              sudo docker exec -u root n8n rm -f /tmp/workflow.json

              echo "    ✓ Imported"
            done

            # Activate all inactive workflows
            echo "==> Activating workflows..."
            sudo docker exec n8n n8n list:workflow --json 2>/dev/null | \
              jq -r '.[] | select(.active == false) | .id' | \
              while read workflow_id; do
                if [ -n "$workflow_id" ]; then
                  sudo docker exec n8n n8n update:workflow --id="$workflow_id" --active=true 2>/dev/null || true
                  echo "  ✓ Activated workflow ID: $workflow_id"
                fi
              done
          else
            echo "  No workflow files found in $WORKFLOW_DIR"
          fi

      - name: Count active workflows
        run: |
          WORKFLOW_COUNT=$(sudo docker exec n8n n8n list:workflow --json 2>/dev/null | jq length || echo "0")
          echo "✓ Active workflows: $WORKFLOW_COUNT"

      - name: Deployment summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Hot deployment successful"
            echo "=========================================="
            echo "Method: Pull-based (self-hosted runner)"
            echo "Commit: ${{ github.sha }}"
            echo "n8n: No restart (workflows kept running)"
            echo "Downtime: 0 seconds"
            echo "=========================================="
          else
            echo "❌ Hot deployment failed"
            echo "=========================================="
            echo "Check logs above for details"
            echo "Backup available in /app/backups/"
            echo "=========================================="
          fi
